				jverb.sty
jverbatim環境―日本語文字と英字が2:1の幅になるverbatimライクな環境の定義
			     v1.06  99/04/21

				 21M / czd16105@nifty.ne.jp   (original)
			      やまね / rsm23381@biglobe.ne.jp (一部修正)

  上記タイトルの通り、verbatim環境に似ているが日本語文字と英字が2:1の幅
になるような「jverbatim環境」を実現する、日本語LaTeX用のスタイルファイル
です。verbコマンドに似た、jverbコマンドというのも用意してあります。
  利点として

  ・NTT JLaTeX、アスキー日本語LaTeXのいずれでも使える
  ・jverb.styさえあれば他に特別なツールやフォントを必要としないし、前処
    理の類もいらないので使用がとても簡単
  ・\ttの英字を日本語文字の自然な幅の半分に合わせるやり方だと英字がやや
    窮屈になってしまうが、jverb.styは(デフォルトでは)そうではなく、日本
    語文字の幅を英字の自然な幅の倍に合わせるので、英字の部分が窮屈になら
    ない

などがあります。
  OSには依存しません。また、LaTeX2ε(の日本語版)でも、(ちょっと試してみ
た限りでは)問題なく使えるようです。
  同様のものが既にありそうな気もしますが、まあ、新たに公開したって害はな
いでしょうから、公開します。
  本品はパブリックドメインとし、作者(21M および やまね)は一切の著作権の
主張をしませんので、誰でも自由に利用・改造・再配布できます。しかし、無保
証ですし、サポートもありません。今後バージョンアップの際は、Vector社の
ftpサイト ftp://www.vector.co.jp にアップロードの予定です(最新版の配布元
がドキュメントに記されていないソフトに泣かされたことがあったので、このこ
とは明記しておきます)。


[使い方]

  インストールの方法は簡単で、お使いの日本語TeXが利用する漢字コードに合
わせてjverb.styの漢字コードを変換し、スタイルファイル用のディレクトリに
コピーするだけです。
  各環境およびコマンドの使い方は以下の通りです。


1. jverbatim環境	使い方: \begin{jverbatim}…\end{jverbatim}

  使い方も機能もverbatim環境とほぼ同じですが、日本語文字と英字は2:1の幅
になります。
  この他にも、以下のような性質がverbatim環境とは異なります。

    [1] タブは無視されず、タブ1つがスペース8つ分(先頭から8の倍数文字目の
	位置まで移動する)の働きを持ちます。
    [2] jverbatim環境に囲まれた先頭行を見て、その行頭にタブがいくつ現れ
	たかを記録しておき、jverbatim環境に囲まれた全ての行の行頭から数
	えて、その個数分までのタブは無視します。

  性質[2]の例としては、

\begin{quote}
[TAB]\begin{jverbatim}
[TAB][TAB]main()
[TAB][TAB]{
[TAB][TAB][TAB]printf("Hello, World.\n");
[TAB][TAB][TAB]printf("こんにちは、世界。\n");
[TAB][TAB]}
[TAB]\end{jverbatim}
\end{quote}

のような場合(「[TAB]」のところには実際には本物のタブコードが入っているも
のとします)、jverbatim環境に囲まれた先頭行には、行頭にタブが2つあります
ので、jverbatim環境に囲まれたすべての行に対し、行頭から2つまでのタブは無
視します。囲まれた3行目は行頭に3つタブがありますので、先頭2つだけ無視さ
れて残り1つが有効になり、8つ分の空白として出力されます。もしこれを避けた
ければ、

\begin{quote}
[TAB]\begin{jverbatim}
 [TAB][TAB]main()
…

のように、先頭行の最初のタブの直前に空白を入れればOKです。
  [1][2]のような性質により、日本語を(注釈などに)含むようなプログラムソー
ス類を、インデントをそのまま生かしてTeXの文書中に取り込むのが非常に楽で
す。
  なお、AUC-TeX(emacsやmuleエディタ上でTeX文書を編集するためのマクロ集)
をお使いの方は、jverbatim環境を使うようなTeX文書を編集する際には、[2]の
性質を生かすために、初期設定ファイル.emacsに

	(setq TeX-auto-untabify nil)

の1行を追加しておく方がよいでしょう(文書中のタブを空白に自動変換しなくな
る)。その他の環境(例えばYaTeXなど)でも同様の注意が必要かも知れません。

  おまけの機能が、以下のように5つあります。

  (1) タブはデフォルトでは空白8文字分ですが、カウンタ\jvtabstopを設定す
ることによって変更もできます。例えば

	\jvtabstop=4

とやると、タブは空白4つ分となります。

  (2) \jvemptylinenarrow に何か長さを設定しておくと、jverbatim環境中に空
行が現れた場合、その幅が \jvemptylinenarrow の分だけ縮まります。例えば

	\setlength{\jvemptylinenarrow}{2pt}

としておくと、jverbatim環境中の空行の幅が2pt縮まります。(空白およびタブ
しか現れない行も「空行」に含まれます)

  (3) 文書中(むろんjverbatim環境の外)で \jvusejisromantrueと書くと、以後、
jverbatim環境の中では、文字コード0x5cの文字がバックスラッシュでなく円マー
クに、文字コード0x7eの文字がチルダでなくオーバーラインになります。つまり、
ASCII文字の代わりにJIS roman(JIS X0201ローマ字)の字体を使うわけです。
\jvusejisromanfalse で元に戻ります。

  (4) 同じく文書中で、\jvkwidthbasetrue と書くと、以後、jverbatim環境の
中で、日本語文字の幅を英字2字分に合わせるのでなく、逆に英字の幅を日本語
文字の半分に合わせます。若干英字部分が窮屈になります。\jvkwidthbasefalse
で元に戻ります。但しこの機能は、ver 1.12より前のNTT JTeXでは使えません。

  (5) jverbatim環境を抜けてから次のjverbatim環境までの間に \jvintermed{数}
と書いておくと、次のjverbatim環境は、前のjverbatim環境の最後から指定した
数カラムだけあけた続きから始まるように処理され、タブ位置も行頭タブ無視個
数も引き継がれます。例えば、「\end{jverbatim}」という文字列を含むような
ものをjverbatim環境で出力したい場合に

	\begin{jverbatim}
		この文章は、[TAB]タブ
		や「\end{jverbatim}」という
		文字列を[TAB]含んでいます。
	\end{jverbatim}

(ここで「[TAB]」のところには実際には本物のタブコードが入っているものとし
ます)とやると途中の「\end{jverbatim}」でjverbatim環境が終わってしまう問
題がありますが、

	\begin{jverbatim}
		この文章は、[TAB]タブ
		や「\end{jver\end{jverbatim}\jvintermed{0}%
	\begin{jverbatim}batim}」という
		文字列を[TAB]含んでいます。
	\end{jverbatim}

のようにするとうまくいき、タブ位置も揃います。また、

	\begin{jverbatim}
		この文章は、途中
		に\end{jverbatim}%
	\jvintermed{2}{\tt\makebox[1em]{$\heartsuit$}}%
	\begin{jverbatim}マークや[TAB]タブを
		含んで[TAB][TAB]います。
	\end{jverbatim}

のような使い方もあります(\ttの場合1emが2カラム分の幅であることに注意)。


2. jverbatim*環境	使い方: \begin{jverbatim*}…\end{jverbatim*}

  jverbatim環境と同様ですが、空白は、verbatim*環境での空白と同様に出力し
ます(タブも空白に変換されて同様に出力される)。


3. jverbコマンド	使い方: 「\jverb」の次に出力したい内容を同じ文字で
			囲んで書く  例…\jverb|cat ファイル名1 ファイル名2|

  verbコマンドと同様ですが、verbコマンドとの違いは、英数字などと日本語文
字との間に通常入る「四分空き」が入らないことです。例えば上の例では、verb
コマンドを使うと、「ファイル名」と「1」の間、およびその次の「ファイル名」
と「2」の間に「四分空き」が入ってしまいます。コンピュータのコマンドライ
ンの説明の時などには、このように微妙な間が空いてしまうと、そこを空けて入
力するのか空けないのかあいまいになり、好ましくありません。jverbコマンド
はそれに対処するため作ったものです。
  jverbコマンドはjverbatim環境と違い、日本語文字と英字が2:1の幅になるよ
うには作ってありません。2:1の幅にしたければ、中身が1行のjverbatim環境で
代用して下さい。また、タブが無視される点もjverbatim環境とは異なります。
  なお、jverbatim環境のおまけ機能のうち(3) (\jvusejisromantrue および
\jvusejisromanfalse によるASCIIとJIS romanの切り替え)は、jverbコマンド内
へも影響を及ぼします。


4. jverb*コマンド	使い方: 「\jverb*」の次に出力したい内容を同じ文字で
			囲んで書く  例…\jverb*|cat ファイル名1 ファイル名2|

  jverbコマンドと同様ですが、空白は、verb*コマンドでの空白と同様に出力し
ます。

				- * -

  このファイルは、スタイルファイルとして使う他、これ自身を直接、LaTeXの
原稿ファイル(*.tex)の中に取り込んで使うこともできます。その場合の長所は、
「dviファイルのみならずtexファイルも、特定の環境(特定のスタイルファイル
の存在)に依存せず、どこでもコンパイルできるようになる」という点です。

  dviドライバによっては、本スタイルファイルで定義した環境やコマンドで、
空白を大量に出力した場合、位置がずれることがあるようです。例えば、
jverbatim*環境で空白を多く含む出力を行うと、右の方では空白マークが縦に揃
わないことがあります。dviファイルのレベルで解析してみると、ずれていない
ようなので、これはdviドライバの不具合ではないかと思います。


※注意事項

  1) ASCII日本語LaTeXでは、日本語がゴシックになっている状況でjverbatim環
境やjverbコマンドを使うと、その内部まで日本語がゴシックになってしまいま
す(NTT JLaTeXでは試していません)。例えば「{\bf\jverb|aあ|}」とすると「あ」
がゴシックになります。日本語が明朝に切り替わるようにした方がよいかなとも
思いましたが、普通のverbatim環境やverbコマンドでも同様なのでそのままにし
てあります。\bfは「{ }」で範囲を限定して使うことが多いので、この仕様で問
題が起きることはほとんどないでしょう。

  2) verbatim環境と異なり、jverbatim環境の前後では自動的に改段落を「しま
せん」。例えば

	abc\begin{jverbatim}
	defdef
	ghighi
	\end{jverbatim}jkl

のような場合、「abc」と「defdef」、「ghighi」と「jkl」は同じ行に来ます。
そうしたくない場合は\parコマンドなどで明示的に改段落して下さい。
  この仕様は、「abc\begin{jverbatim}dあいe\end{jverbatim}fgh」のように、
中身が1行のjverbatim環境をjverbコマンドの代用として使うためのものです(上
記3.の「jverbコマンド」の項参照)。
  ただ、この仕様のため次のような現象が起こります。

	{\baselineskip8pt\begin{jverbatim}
	abcabc
	defdef
	ghighi
	jkljkl
	\end{jverbatim}}

のような場合(6行目の「\end{jverbatim}}」の行頭には空白はないものとします)、
jverbatim環境内の行間は8ptになりますが、最後の2行の間だけが通常の行間に
戻ってしまいます。これは、

  ・\baselineskipの設定は段落の中で有効(直前の改段落までが\baselineskip
    の設定の影響の及ぶ範囲)。
  ・jverbatim環境は各行を独立の段落としている(jverbatim環境の中身が長い
    場合、全体を1段落にするとメモリ溢れを起こしやすいため)。従って、
    「jkljkl」の行の直前にも改段落がある。
  ・一方、「jkljkl」の行の直後には改段落が行われないため、「jkljkl」の行
    は「\end{jverbatim}」の続きと同じ段落。
  ・よって、その段落の最後の時点での\baselineskipの値(最後の「}」を抜け
    たことによって元に戻っている)が、「jkljkl」の行の直前の改段落におい
    ても使われる。

という事情によります。「\end{jverbatim}\par}」のように、最後の「}」を抜
ける前に明示的に改段落すればこの現象は回避できます。

  3) 本物のverbatim環境や\verbコマンドと同様、このjverbatim環境や\jverb
コマンドも、その実現の仕方の関係上、他のマクロの引数の中で使うことはでき
ません(他の環境の中で使うことはできます)。どうしても使いたければ、使いた
い内容を一旦箱レジスタに代入し、それを他のマクロの引数で使うという手法を
取ります。下記が具体例で、jverbコマンドを箱に代入してそれを\fboxマクロの
引数として使っています(参考: 磯崎秀樹「LaTeX自由自在」サイエンス社)。こ
の方法はverbコマンドやverbatim環境にも通用します。

	\newsavebox{\verbbox}				% 箱を宣言
	\setbox\verbbox=\hbox{%
	\jverb|prompt% cp ファイル名1 ファイル名2|}	% 箱に代入
	\fbox{\usebox{\verbbox}}			% 箱を使用


※変更履歴

1.00→1.01 (by 21M)
  ・行頭で、\jverb| abc|のように先頭に空白のある出力をjverbコマンドで行
うと、その行の上が不当に空いていたのを直した。
  ・\jverbは、\verbと違って途中での行折り曲げを必要に応じて行うようになっ
た。その方が便利と作者が判断したため。
  ・jverbatim環境のタブストップが8に固定だったのを可変にした。

1.01→1.02 (by やまね)
  ・\jvemptylinenarrow を新設し、jverbatim環境中の空行の幅を調節可能にし
た。
  ・以前は、jverbatim環境の中身が数百行(標準的な場合で)を越えると、TeX
capacity exceededを引き起こしていたが、今回からは(1行が極端に長くない限
り)中身がいくら多くても大丈夫。
  ・アスキー日本語TeX(の古い版?)のバグのため、これまで同TeXではjverbatim
環境の中身に『「\」+日本語文字』というものが混じっていると誤動作していた。
これへの対策を行った。
  ・おまけk2tex2ps(但しUNIX専用)を添付。

1.02→1.02b (by やまね)
  ・jverb.styそのものは1.02と全く変わっていない。おまけのk2tex2psの若干
の不具合を手直ししただけ。

1.02b→1.03 (by 21M&やまね)
  ・内部で使っているマクロが他のスタイルファイルと衝突して問題が起こる場
合があることが判明したため、マクロ名を衝突しにくそうなものに変更。

1.03→1.04 (by 21M)
  ・定義したのに使ってなかった箱レジスタの定義1つを消した。
  ・円マークとバックスラッシュ、オーバーラインとチルダの切り替えを可能に
した。
  ・英字の幅を日本語文字の半分に合わせることもできるようにした。
  ・やまね氏はドキュメントの英数字に2バイト文字を使う傾向があるようだが、
1バイト文字に統一してしまった(^^;)

1.04→1.05 (by 21M)
  ・「著作権の主張はしない」旨を明記した。
  ・\jvintermedコマンドを新設。

1.05→1.06 (by 21M)
  ・1.05では、jverbatim環境をASCII日本語TeXで使うと「、」「“」など幅の
狭い日本語記号文字が常に1字分の幅の真ん中に来ていた。適切な位置に寄るよ
うに直した。
  ・1.05で、typeoutされるバージョン番号が誤って1.5になっていた。
